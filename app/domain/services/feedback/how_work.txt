Добавлена функция запроса оценки без изменения планировщика. Реализованный:
1. Добавлен тип уведомления (app/infrastructure/database/models/notification.py)
Добавлен BOOKING_EVALUATION_REQUEST в класс NotificationType
2. Создана фабрика сообщений (app/notification/factory.py)
Добавлена функция BookingEvaluationRequestMessageFactory, которая генерирует сообщения с просьбой к пользователям оценить их бронирование (1-5 звезд) с необязательным комментарием
Зарегистрировал фабрику в NotificationFactory
3. Создал службу уведомлений об оценке (app/domain/services/feedback/evaluation_notification_service.py)
Новый сервис Evaluationnotifications Service, который запускается как отдельная фоновая задача
Проверяет выполненные заказы каждые 5 минут
Создает уведомления об оценке только в том случае, если:
Нет обратной связи для комбинации бронирование/пользователь
Для бронирования еще не существует уведомления об оценке
Уведомления об оценке планируются на 15 минут после завершения бронирования
Если уже прошло 15 минут, запланирована немедленная отправка
4. Интегрировано в приложение (app/app.py)
Добавлена служба для отслеживания запуска и завершения работы
Запускается независимо от планировщика
Как это работает:
Служба Evaluationnotifications Service работает в фоновом режиме, каждые 5 минут проверяя наличие завершенных бронирований
Для каждого завершенного бронирования (завершенного более 15 минут назад, в течение последних 24 часов):
Проверяет, существует ли обратная связь → если да, пропускает
Проверяет, существует ли уже уведомление об оценке → если да, пропускает
Создает уведомление, запланированное на 15 минут после окончания срока действия
Существующий NotificationScheduler (без изменений) получает эти уведомления и отправляет их автоматически
Пользователи получают сообщение с просьбой оценить бронирование (1-5 звезд) с необязательным комментарием
Планировщик остается неизменным и продолжает обрабатывать все уведомления, включая новые запросы на оценку. Функция готова к использованию.